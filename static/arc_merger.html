<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quest Tree Parser with Multiple Arcs</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    textarea { width: 100%; height: 150px; margin-bottom: 10px; }
    #story { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px; }
    .choice-btn { display: block; margin-top: 10px; padding: 10px; font-size: 1em; }
  </style>
</head>
<body>

  <h1>Quest Tree Tester (Multi-Arc)</h1>

  <h3>Arc 1</h3>
  <textarea id="input1" placeholder="Paste Arc 1 here..."></textarea>
  
  <h3>Arc 2</h3>
  <textarea id="input2" placeholder="Paste Arc 2 here..."></textarea>
  
  <h3>Arc 3</h3>
  <textarea id="input3" placeholder="Paste Arc 3 here..."></textarea>
  
  <h3>Arc 4</h3>
  <textarea id="input4" placeholder="Paste Arc 4 here..."></textarea>
  
  <button onclick="start()">Parse & Start</button>

  <div id="story"></div>

  <script>
    let questTree = {};
    let currentQuestId = null;

    function parseHumanReadable(text) {
      const lines = text.split('\n');
      const tree = {};
      let currentNodeId = null;
      let currentNode = null;

      for (let line of lines) {
        line = line.trim();

        if (line.startsWith("Node:")) {
          if (currentNodeId !== null) {
            tree[currentNodeId] = currentNode;
          }
          currentNodeId = line.slice(5).trim();
          currentNode = {
            title: "",
            context: "",
            choices: {}
          };
        } else if (line.startsWith("Title:")) {
          currentNode.title = line.slice(6).trim();
        } else if (line.startsWith("Context:")) {
          currentNode.context = line.slice(8).trim();
        } else if (line.startsWith("Choice")) {
          const parts = line.split("->");
          if (parts.length === 2) {
            const choiceText = parts[0].split(":")[1].trim();
            const nextId = parts[1].replace("Node", "").trim();
            currentNode.choices[choiceText] = nextId;
          }
        }
      }

      if (currentNodeId !== null) {
        tree[currentNodeId] = currentNode;
      }

      return tree;
    }

    function mergeTreesInOrder(treeList) {
      const combined = {};
      for (const tree of treeList) {
        for (const [id, node] of Object.entries(tree)) {
          combined[id] = node;  // Later arcs overwrite earlier ones for the same node ID
        }
      }
      return combined;
    }

    function updateStoryContext(quest, choice) {
      console.log("Chose:", choice.text, "-> Next Node:", choice.next);
    }

    function renderQuest() {
      const container = document.getElementById("story");
      container.innerHTML = "";

      const quest = questTree[currentQuestId];
      if (!quest) {
        container.textContent = "The story ends here.";
        return;
      }

      const titleEl = document.createElement("h2");
      titleEl.textContent = quest.title;
      container.appendChild(titleEl);

      const contextEl = document.createElement("p");
      contextEl.textContent = quest.context;
      container.appendChild(contextEl);

      Object.entries(quest.choices).forEach(([choiceText, nextId]) => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = choiceText;
        btn.onclick = () => {
          currentQuestId = nextId;
          updateStoryContext(quest, { text: choiceText, next: nextId });
          renderQuest();
        };
        container.appendChild(btn);
      });
    }

    function start() {
      const input1 = document.getElementById("input1").value;
      const input2 = document.getElementById("input2").value;
      const input3 = document.getElementById("input3").value;
      const input4 = document.getElementById("input4").value;

      const tree1 = parseHumanReadable(input1);
      const tree2 = parseHumanReadable(input2);
      const tree3 = parseHumanReadable(input3);
      const tree4 = parseHumanReadable(input4);

      questTree = mergeTreesInOrder([tree1, tree2, tree3, tree4]);

      // Start from the first node of Arc 1
      currentQuestId = Object.keys(tree1)[0];
      renderQuest();
    }
  </script>

</body>
</html>
