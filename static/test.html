<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Life Simulator Game</title>
  <link rel='stylesheet' type='text/css' href='test_progbar.css'>
</head>
<body>
  <div class="wrapper">
    <!-- Game data & story -->
    <div class="game-stats">
      <h3>Soulbound - Live a Thousand Lives</h3>
      <pre class="json-output" id="gameData">Loading...</pre>
      <div id="progressBars">
        <!-- Progress bars will be inserted here -->
      </div>
    </div>

    <!-- Player choices -->
    <div class="quiz-container">
      <form id="promptForm">
        <button type="submit">Generate Questions</button>
    </form>
    <div id="quizContainer" style="margin-top: 20px;"></div>
    <div id="resultContainer" style="margin-top: 20px;"></div>
    </div>
  </div>

<script>
const rawData = {
  "personality": {
    "alignment": "good",
    "archetype": "Guardian",
    "bravery": 7,
    "curiosity": 3,
    "empathy": 8,
    "logic": 6,
    "primary": "empathy",
    "secondary": "bravery",
    "stats": {
      "bravery": 7,
      "curiosity": 3,
      "empathy": 8,
      "logic": 6
    }
  },
  "start": {
    "location": "Khmer Empire, Cambodia",
    "role": "Governor's Advisor",
    "situation": "As a guardian with a deep empathy for the people, you have been appointed as a governor's advisor, overseeing the welfare of the kingdom's citizens. However, your bravery and the well-being of your subjects are tested when a drought threatens the survival of the empire, questioning the traditional ways and pushing you to seek unconventional solutions.",
    "time_period": "10th Century CE"
  }
};
let parsed = null; // Declare parsed globally so it's accessible later

if (rawData) {
//   try {
    parsed = rawData; //     parsed = JSON.parse(decodeURIComponent(rawData)); // This is the original code. Disabled for testing.
    document.getElementById("gameData").textContent = JSON.stringify(parsed.start, null, 2);
//   } catch (err) {
//     document.getElementById("gameData").textContent = "❌ Failed to parse game data.";
//   }
// } else {
//   document.getElementById("gameData").textContent = "⚠️ No data received.";
}
// Parse player data code ends here

let currentQuestions = [];

document.getElementById("promptForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    // Use parsed data to define the topic
    const archetype   = parsed?.personality?.archetype || "mysterious";
    const location    = parsed?.start?.location || "unknown";
    const role        = parsed?.start?.role || "unknown";
    const situation   = parsed?.start?.situation || "unknown";
    const timePeriod  = parsed?.start?.time_period || "unknown";

    const topic = `Generate game-like moral dilemma questions for someone with a ${archetype} archetype. The background of the character is as follows- location is ${location}, the player assumes the role of ${role}, situation is- ${situation}, timePeriod is ${timePeriod}.`;

    console.log(topic);

    // Inject topic into formData so the backend receives it
    formData.set("topic", topic);

    const quizDiv = document.getElementById("quizContainer");
    const resultDiv = document.getElementById("resultContainer");
    resultDiv.innerHTML = "";
    quizDiv.innerHTML = "<p>Generating questions...</p>";

    const res = await fetch("/generate", {
        method: "POST",
        body: formData
    });

    const resClone = res.clone();
    let data;

    try {
        data = await res.json();
    } catch (err) {
        const raw = await resClone.text();
        quizDiv.innerHTML = `<p style="color:red;">Server did not return valid JSON.</p><pre>${raw}</pre>`;
        return;
    }

    if (data.error) {
        quizDiv.innerHTML = `<p style="color:red;">Error: ${data.error}</p><pre>${data.details || ''}</pre>`;
        return;
    }

    currentQuestions = data.questions;
    quizDiv.innerHTML = `<form id="quizForm"></form>`;
    const quizForm = document.getElementById("quizForm");

    currentQuestions.forEach((q, i) => {
        const optionsHTML = q.options.map((opt, j) => `
            <label>
                <input type="radio" name="q${i}" value="${opt}" required>
                ${opt}
            </label><br>`).join("");

        quizForm.innerHTML += `
            <div style="margin-bottom: 20px;">
                <strong>Q${i + 1}:</strong> ${q.question}<br>
                ${optionsHTML}
            </div>
        `;
    });

    quizForm.innerHTML += `<button type="submit">Submit Answers</button>`;

    quizForm.addEventListener("submit", (e) => {
        e.preventDefault();
        let score = 0;
        const results = [];

        currentQuestions.forEach((q, i) => {
            const selected = quizForm.querySelector(`input[name="q${i}"]:checked`);
            const userAnswer = selected ? selected.value : "";
            const isCorrect = userAnswer === q.answer;

            results.push({
                question: q.question,
                correct: q.answer,
                selected: userAnswer,
                isCorrect
            });

            if (isCorrect) score++;
        });

        let resultHTML = `<h2>Your Score: ${score} / ${currentQuestions.length}</h2>`;
        results.forEach((r, i) => {
            resultHTML += `
                <div style="margin-bottom: 15px;">
                    <strong>Q${i + 1}:</strong> ${r.question}<br>
                    Your answer: <span style="color: ${r.isCorrect ? 'green' : 'red'};">${r.selected || '(blank)'}</span><br>
                    Correct answer: ${r.correct}
                </div>
            `;
        });

        resultDiv.innerHTML = resultHTML;
    });
});

// Progress bar script START

// Initial stat values (0–10 scale)
    const stats = {
      bravery: 7,
      curiosity: 3,
      empathy: 8,
      logic: 6
    };

    // Render gameData and progress bars
    function renderGameData() {
      document.getElementById("gameData").textContent = JSON.stringify(stats, null, 2);
    }

    function renderProgressBars() {
      const container = document.getElementById("progressBars");
      container.innerHTML = ''; // Clear existing bars
      for (const key in stats) {
        const percent = Math.min(100, Math.max(0, stats[key] * 10)); // 0–100%
        container.innerHTML += `
          <div class="progress-bar-container">
            <div class="progress-label" id="label-${key}">${key.charAt(0).toUpperCase() + key.slice(1)} (${stats[key]}/10)</div>
            <div class="progress">
              <div class="progress-fill" id="bar-${key}" style="width: ${percent}%;"></div>
            </div>
          </div>
        `;
      }
    }

    // Update bars after change
    function updateProgressBars() {
      for (const key in stats) {
        const percent = Math.min(100, Math.max(0, stats[key] * 10));

        const bar = document.getElementById(`bar-${key}`);
        if (bar) {
          bar.style.width = `${percent}%`;
        }

        const label = document.getElementById(`label-${key}`);
        if (label) {
          label.textContent = `${key.charAt(0).toUpperCase() + key.slice(1)} (${stats[key]}/10)`;
        }
      }
  }

// Wait for DOM to load before rendering
window.addEventListener("DOMContentLoaded", () => {
  renderProgressBars();
  updateProgressBars(); // Optional: to refresh label & gameData JSON
});

// Progress bar script END
</script>

</body>
</html>